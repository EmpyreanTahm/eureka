---
title: "浅析 HTTPS"
author: "GeekKery"
date: 2021-01-15T20:14:56+08:00
tags: ["HTTP", "安全"]
---

## HTTP 的缺点

HTTP 具有相当优秀的和方便的一面，简单、灵活、易于扩展是它显著的特点。然而 HTTP 并非只有好的一面，事物皆具有两面性，它也有不足之处。

### 明文通信

HTTP 本身不具备加密的功能，无法做到对通信整体进行加密。按 TCP/IP 协议族的工作机制，通信内容在所有的通信线路上都有可能遭到窥视。窃听相同段上的通信并非难事。只需要收集在互联网上流动的数据包，然后使用抓包或嗅探器工具对收集来的数据包进行解析即可。

### 不验证通信方的身份

HTTP 协议中的请求和响应不会对通信方进行确认，任何人都可以发起请求。服务器只要接收到请求，并且发送端的 IP 地址和端口号没有被 Web 服务器设定限制访问，不管对方是谁都会返回一个响应，这样会存在以下隐患：无法确定请求的目标服务器是否是按真实意图返回响应的那台服务器，有可能是已伪装的 Web 服务器；无法确定响应返回的客户端是否是按真实意图接收响应的那个客户端，有可能是已伪装的客户端；无法确定正在通信的对方是否具备访问权限；无法判定请求是来自何方、出自谁手；即使是无意义的请求也会照单全收，无法阻止海量请求下的 DoS 攻击。

### 无法证明报文完整性

完整性是指信息的准确度。若无法证明其完整性，通常也就意味着无法判断信息是否准确。HTTP 协议无法证明通信的报文完整性，因此，在请求或响应送出之后直到对方接收之前的这段时间内，如果请求或响应遭到篡改，也没有办法获悉。

## HTTPS 是什么

HTTPS（HTTP Secure）并非是应用层的一种新协议，只是 HTTP 通信接口部分用 SSL（Secure Socket Layer） 或 TLS（Transport Layer Security）协议代替而已。当使用 SSL/TLS 时，HTTP 先和 SSL/TLS 通信，再由 SSL/TLS 和 TCP 通信。在采用 SSL/TLS 后，HTTP 就拥有了 HTTPS 的加密、认证和完整性保护这些功能。

SSL 技术最初是由网景公司率先倡导的，开发过 SSL3.0 之前的版本，目前主导权已转移到 IETF（Internet Engineering Task Force，Internet 工程任务组）的手中。IETF 以 SSL3.0 为基准，后又制定了 TLS1.0、TLS1.1 和 TLS1.2。TLS 是以 SSL 为原型开发的协议，有时会统一称该协议为 SSL。当前的主流协议是 SSL3.0 和 TLS，SSL1.0 在设计之初被发现出了问题，就没有实际投入使用。SSL2.0 也被发现存在问题，所有很多浏览器直接废除了该协议版本。

## HTTPS = HTTP + 加密 + 认证 + 完整性保护

### 对称加密

对称加密使用同一串密钥加密和解密，因此被称做对称加密，常见的对称加密算法有 DES、3DES、AES、Blowfish、IDEA、RC5 和 RC6 等。对称加密通常使用的是相对较小的密钥，一般小于 256bit。密钥越大，加密越强，但加密与解密的过程越慢。密钥的大小既要照顾到安全性，也要照顾到效率。

对称加密的缺点是密钥的管理与分配，在发送密钥的过程中，密钥有很大的风险会被黑客们拦截，如何将对称密钥安全地交付给对方是一个问题。

### 非对称加密

非对称加密算法需要两个密钥：公开密钥（简称公钥）和私有密钥（简称私钥）。**公钥与私钥是一对，公钥加密的信息，只有私钥才能解密；反之，私钥加密的信息，只有公钥才能解密**。因为加密和解密使用的是两个不同的密钥，所以这种算法叫作非对称加密算法。RSA 算法是应用最广泛的非对称加密算法，具体原理可参考文章：[RSA算法原理（一）](http://www.ruanyifeng.com/blog/2013/06/rsa_algorithm_part_one.html) 和 [RSA算法原理（二）](http://www.ruanyifeng.com/blog/2013/07/rsa_algorithm_part_two.html)。

非对称加密算法实现机密信息交换的基本过程是：甲生成一对密钥并将公钥公开，需要向甲发送信息的乙用甲的公钥对信息进行加密后再发送给甲；甲再用自己的私钥对加密后的信息进行解密。甲想要回复乙时正好相反，使用乙的公钥对数据进行加密，同理，乙使用自己的私钥来进行解密。

虽然非对称加密更安全，但和对称加密相比，加解密的效率低很多，所以理想状态是用对称加密来传送消息，通过非对称加密的方式发送对称加密所使用的密钥，这正是 HTTPS 所采用的方式。

### HTTPS 加密

HTTPS 加密的过程可以参考以下案例：

1. Jayden 需要在银行的网站做一笔交易，他的浏览器首先生成了一个随机数作为对称密钥；
2. Jayden 的浏览器向银行的网站请求公钥；
3. 银行将公钥发送给 Jayden；
4. Jayden 的浏览器使用银行的公钥将自己的对称密钥加密；
5. Jayden 的浏览器将加密后的对称密钥发送给银行；
6. 银行使用私钥解密得到 Jayden 浏览器的对称密钥；
7. Jayden 与银行可以使用对称密钥来对沟通的内容进行加密与解密。

这个过程中，公钥是公开分发的，任何人都可以拿到公钥，只有银行的私钥能对公钥加密的信息进行解密。所以，即使信息被截取，没有银行的私钥，也无法知晓信息的内容。

但是这里又有新的问题，既然网络是不安全的，那么银行发给 Jayden 的公钥就有被截取和篡改的可能。按照这个思路来，黑客在银行返回给 Jayden 公钥时，完全可以将公钥替换成黑客自己的公钥，Jayden 拿到公钥以后将对称密钥进行加密，发送银行。此时黑客用自己的私钥解密出对称密钥，再使用银行的公钥加密对称密钥发送银行，到此，Jayden 和银行双方都不会发现异常，之后继续进行通信，而黑客却能一直监听和获取后续通信的内容。

综上，由于通信内容明文有安全隐患，采用了对称密钥加密通信内容，但对称密钥暴露的风险较大，因此使用非对称加密传送对称密钥，但非对称加密同样有公钥被截取篡改的风险。只要**保证公钥安全的传送给通信方**，就能保证对称密钥的安全性，整个通信过程也就安全了，这就是数字证书的来历。

### 数字证书

为了保证服务器返回的公钥是未被篡改的，有了 CA（Certificate Authority）的概念，就是证书授权机构，是第三方的权威机构，虽然历史上也有 CA 机构被攻破的例子，但理论上是权威可靠的。

服务器要申请证书，首先要向 CA 机构提供**公钥**、组织信息、域名等信息并申请认证，CA 通过线上、线下等多种手段验证申请者提供信息的真实性，如组织是否存在、企业是否合法，是否拥有域名的所有权等。审核通过后，CA 机构会向申请者签发认证文件 --- 证书。证书包含以下信息：**申请者公钥**、申请者的组织信息和个人信息、签发机构的信息、有效时间、证书序列号等信息的明文，同时包含一个签名。

CA 机构有一对公、私钥，它把申请者的公钥和基本信息用他的**私钥**加密成密文，把这个密文当做电子签名签在证书上，然后再把自己的公钥给客户端，那么客户端收到 CA 机构给的证书之后，就可以利用 CA 机构给的公钥解密证书上面的签名，客户端最后将解密出来的服务器公钥去加密对称密钥，将之发送服务器进行后续通信。

**证书 = 服务器公钥 + 服务器与颁发者信息 + 签名**，证书的安全性依靠签名保证，签名即 CA 机构的公钥加密后的密文。

**中间人虽然有权威机构的公钥，能够解析证书内容并篡改，但是篡改之后中间人需要将证书重新加密，但是中间人没有权威机构的私钥，无法加密，强行加密只会导致客户端无法解密，如果中间人强行修改证书，就会导致证书内容和证书签名不匹配。**

截止目前，又会有新的问题，即如何获取 CA 机构的公钥，又如何保证 CA 机构公钥的正确性呢？其实，操作系统或浏览器会预装第三方 CA 机构的证书，如此免去互联网上传输的风险，正因如此，用户需要安装正版的操作系统和可信任的官方浏览器，否则，基础都不安全，上层应用也就没有安全性保障。

综上，首先我们要理解，CA 机构的公钥已经预存到了客户端，理论安全。CA 机构在认证了服务方后，会生成证书，交给服务方，**证书 = 服务器公钥 + 服务器与颁发者信息 + 签名**，签名即 CA 机构公钥加密的证书内容。客户端在与服务器通信时，服务器首先返回证书，客户端用 CA 机构的公钥解密来验证证书内容和签名信息是否一致，一致则利用服务器公钥进行后续通信。在这个过程中，中间人由于没有 CA 机构密钥，即使用 CA 机构的公钥解密证书内容，也无法进行加密，只有用 CA 机构私钥加密的内容，才能用 CA 机构的公钥解密，因此，中间人无从下手。

### 散列函数保证完整性

常见的 Hash 函数有 MD5、SHA1、SHA256，该类函数特点是函数单向不可逆、对输入非常敏感、输出长度固定，针对数据的任何修改都会改变散列函数的结果，用于防止信息篡改并验证数据的完整性。

在信息传输过程中，散列函数不能单独实现信息防篡改，因为明文传输，中间人可以修改信息之后重新计算信息摘要，因此需要对传输的信息以及信息摘要进行加密。

通过这种加密方式生成数字签名，从而保证数据的完整性。将一段文本用 Hash 函数生成消息摘要，然后用发送者的私钥加密生成数字签名，与原文一起传送给接收者。

接收者用发送者的公钥解密被加密的摘要信息，然后用散列函数对收到的原文产生一个摘要信息，与上一步得到的摘要信息对比。如果相同，则说明收到的信息是完整的，在传输过程中没有被修改，否则说明信息被修改过，因此数字签名能够验证信息的完整性。

## HTTPS 的缺点

HTTPS 普遍被认为性能消耗要大于 HTTP，因为与纯文本通信相比，加密通信会消耗更多的 CPU 及内存资源。如果每次通信都加密，会消耗相当多的资源，平摊到一台计算机上时，能够处理的请求数量也会随之减少。

除此之外，要进行 HTTPS 通信，证书是必不可少的。而使用的证书必须向 CA 机构购买。

## 总结

HTTPS 协议的主要功能基本都依赖于 TLS/SSL 协议，TLS/SSL 的功能实现主要依赖于三类基本算法：对称加密、非对称加密和散列函数，利用非对称加密实现身份认证和密钥协商，对称加密算法采用协商的密钥对数据加密，基于散列函数验证信息的完整性。

