# TCP 和 UDP

TCP 是**面向连接的**、**可靠的**、**基于字节流**的传输层通信协议：
- 面向连接：TCP 只能建立一对一的连接，不能像 UDP 协议那样，一个主机可以同时向多个主机发送消息
- 可靠的：TCP 可以保证数据在网络链路中发生变化时，仍然能够正确地到达接收端
- 字节流：用户消息通过 TCP 协议传输时，消息可能会被操作系统分割成多个 TCP 报文，如果接收方的程序不知道消息的边界，就无法读出一个完整的用户消息。并且 TCP 报文是有序的，如果先收到了后面的 TCP 报文，也不能交给应用层处理，同时对重复的 TCP 报文会自动丢弃

![tcp-header-format](/TCP和UDP/tcp-header-format.webp)

## 三次握手

TCP 是面向连接的协议，使用 TCP 前必须先建立连接，建立连接通过三次握手进行：

![TCP-shake-hands-three-times](/TCP和UDP/TCP-shake-hands-three-times.webp)

步骤如下：
1. 客户端初始化随机序列号 `client_isn` 并置于 TCP 首部的序列号字段，同时将 `SYN` 标志位置为 `1`，接着将第一个 `SYN` 报文发送服务端，表示向服务器发起连接请求，此时客户端处于 `SYN-SENT` 状态
2. 服务端接收到 `SYN` 报文后，首先初始化自己的序列号 `server_isn` 并置于 TCP 首部的序列号字段，然后将 `client_isn + 1` 的结果填入 TCP 首部的确认应答号字段，接着将 `SYN` 和 `ACK` 标志位置为 `1` 后，发送该报文给客户端，此时服务端处于 `SYN-RCVD` 状态
3. 客户端收到服务端报文后，将 `server_isn + 1` 置于 TCP 首部字段的确认应答号字段，同时将 `ACK` 标志位置为 `1`，接着将报文发送（可以携带数据）服务端，客户端此时处于 `ESTABLISHED` 状态；服务端接收到客户端的应答报文后，也进入 `ESTABLISHED` 状态

采用三次握手可以：
- 三次握手才可以阻止重复历史连接的初始化（主要原因）
- 三次握手才可以同步双方的初始序列号
- 三次握手才可以避免资源浪费

### 避免历史连接

若遇到网络阻塞，客户端发出的 `SYN` 报文没有响应时，会重新发送不同 `client_isn` 的 `SYN` 报文，新、旧 `SYN` 报文到达服务器的顺序并不确定。

如果旧 `SYN` 报文先到，那么服务端会回一个 `SYN + ACK` 报文给客户端，客户端收到后可以根据自身的上下文，判断这是一个历史连接（序列号过期或超时），那么客户端就会发送 `RST` 报文给服务端，表示中止这一次连接。

如果新 `SYN` 报文先到，那么服务端会回一个 `SYN + ACK` 报文给客户端，客户端收到后会正常建立连接。服务端如何知道后续收到的 `SYN` 报文是旧的呢？这是因为服务端会维护**半连接队列**和**全连接队列**，每个连接请求都有一个唯一的四元组即源 IP、源端口、目的 IP、目的端口和一个初始序列号 `ISN`。

当服务端收到一个新的 `SYN` 报文时，会检查连接队列中是否已经存在相同的四元组，如果存在，就会比较两个 `SYN` 报文中的 `ISN`，如果刚收到报文的 `ISN` 小于队列连接的 `ISN`，说明这是一个旧的连接请求，就会直接丢弃刚收到的 `SYN` 报文，不予处理。

如果采用两次握手创建连接，无法防止历史请求创建连接，造成资源浪费。

### 同步双方初始序列号

最少需要三次握手，才能确保双方的初始序列号能被可靠地同步。序列号是可靠传输的一个关键因素，它的作用除了创建时的相互确认外：
- 帮助接收方按照正确的顺序重新组装数据
- 用于确认之前的数据是否被正常接收，TCP 的数据包中都包含序列号和确认号，每次数据包的传输都会累加，如果有实体内容，会累加实体的字节数
- 实现超时重传，快速重传等，保证数据的可靠性

## 四次挥手

TCP 是面向连接的协议，使用 TCP 后必须断开连接，断开连接通过四次挥手进行：

![TCP-wave-four-times](/TCP和UDP/TCP-wave-four-times.webp)

步骤如下：
1. 客户端打算关闭连接，会发送一个 TCP 首部 `FIN` 标志位被置为 `1` 的报文，即 `FIN` 报文，之后客户端进入 `FIN_WAIT_1` 状态
2. 服务端收到 `FIN` 报文后，回复一个 `ACK` 报文给客户端，并进入 `CLOSE-WAIT` 状态
3. 客户端收到 `ACK` 报文后，进入 `FIN-WAIT-2` 状态
4. 服务端发送完所有数据后，发送一个 `FIN` 报文给客户端，并进入 `LAST-ACK` 状态
5. 客户端收到 `FIN` 报文后，回复一个 `ACK` 报文给服务端，并进入 `TIME-WAIT` 状态
6. 服务端收到 `ACK` 报文后，关闭连接，并进入 `CLOSED` 状态
7. 客户端等待 `2MSL` 后，关闭连接，并进入 `CLOSED` 状态

`MSL`（Maximum Segment Lifetime），即报文最大生存时间，设置 `2MSL` 延迟关闭可以：
- 允许报文至少丢失一次，保证客户端最后一个 `ACK` 报文段能够到达服务端。若遇到报文丢失，服务端重传 `FIN` 后，客户端还能重传 `ACK` 继续进入 `TIME-WAIT` 重新计时，保证服务端的正常关闭
- 防止历史连接中的数据，被后面相同四元组的连接错误地接收。如若没有延迟时间，服务端若重建相同四元组的 TCP 连接，可能返回上一个 TCP 连接中延迟的包，被客户端错误地接收，延迟时间让双方有足够的事件清除数据包

## 可靠传输

### 重传机制

当发送方发现数据包丢失或者超时没有收到接收方的确认应答时，就会重新发送数据包。

TCP 使用序列号和确认号来标识每个数据包，并且在发送缓存中保存已发送但未确认的数据包。接收方收到数据包后，会发送一个确认应答给发送方，表示已经正确接收到数据包。发送方收到确认应答后，就会从发送缓存中删除对应的数据包。

如果发送方没有收到确认应答，就会触发重传机制，重新发送数据包，保证数据的完整性和有序性。

### 流量控制

滑动窗口是 TCP 实现流量控制和拥塞控制的一种机制。发送方和接收方各自维护一个窗口大小，表示可以发送或接收的数据量。窗口大小会根据网络状况和接收能力动态调整，以避免发送方过快地发送数据导致接收方或网络拥塞。滑动窗口的工作原理如下：
- 发送方在每个数据包中指明自己的窗口大小（即发送缓存中剩余的空间），表示还能发送多少字节的数据
- 接收方在每个确认应答中指明自己的窗口大小（即接收缓存中剩余的空间），表示还能接收多少字节的数据
- 发送方在发送数据时，要保证已发送但未确认的数据量不超过接收方的窗口大小，即不能超过对方能够接收的范围
- 接收方在接收数据时，要保证按序到达的数据量不超过自己的窗口大小，即不能超过自己能够处理的范围
- 当发送方或接收方收到对方的窗口更新时，就会相应地调整自己的窗口大小，并且根据新的窗口大小继续发送或接收数据
- 当发送方或接收方发现网络拥塞时（例如发生了超时重传或丢包），就会减小自己的窗口大小，以降低发送速率，并且启动慢启动或拥塞避免算法来恢复正常传输

### 拥塞控制

慢启动是一种用于探测网络容量的算法，它指的是当TCP连接建立或超时后，发送方将拥塞窗口设置为一个较小的值，然后每收到一个确认应答就将拥塞窗口加一，使得每个往返时间内拥塞窗口呈指数增长。这样可以避免一开始就发送过多的数据包导致网络拥塞。当拥塞窗口达到一个慢启动阈值（ssthresh）时，发送方就会进入拥塞避免阶段。

拥塞避免是一种用于保持网络稳定的算法，它指的是当 TCP 连接进入稳定传输阶段后，发送方将拥塞窗口按线性增长，即每个往返时间内只增加一个 `MSS`，避免拥塞窗口增长过快导致网络拥塞。当网络出现拥塞时（如发生超时重传或收到三个重复应答），发送方就会减小拥塞窗口，并重新进入慢启动或快速恢复阶段。

## UDP

UDP 是用户数据报协议（User Datagram Protocol）的缩写，它是一种无连接的传输层协议，提供面向事务的简单不可靠信息传送服务 。UDP 的主要特点有：

- 无连接：UDP 不需要在发送数据之前建立连接，也不需要维护连接状态，因此可以减少开销和延迟
- 不可靠：UDP 不保证数据包的到达、顺序和完整性，也不提供重传、确认和流量控制等机制，因此可能出现丢包、错序和重复等现象。如果需要可靠性，应用层需要自己实现
- 快速：UDP 由于没有连接和可靠性的开销，可以实现较高的传输效率和实时性，适合对速度敏感的应用
- 简单：UDP 的报文格式很简单，只有四个字段：源端口、目的端口、长度和校验和。UDP 的报头只占用 8 个字节，相比 TCP 的 20 个字节，减少了分组首部的开销

UDP 的主要应用有：

- 流媒体：如音频和视频传输，可以容忍一定的数据丢失，但要求低延迟和高吞吐量
- 实时通信：如 VoIP（基于 IP 的语音通信），需要保证通话的连贯性和清晰度，不能等待重传
- 简单查询：如 **DNS（域名解析服务）**，一般只需要发送一次请求和接收一次响应，无需建立连接
- 广播和组播：如 DHCP（动态主机配置协议），可以使用 UDP 在网络中发送广播或组播数据包，实现地址分配等功能
