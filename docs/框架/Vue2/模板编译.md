# 模板编译

模板中可以使用表达式、指令、HTML 标签以及自定义标签。模板编译的主要目的是**生成渲染函数**，渲染函数执行后返回新的虚拟 DOM。

生成渲染函数的步骤：
1. 解析器：将模板解析成 AST（Abstract Syntax Tree，抽象语法树）
2. 优化器：遍历 AST 标记静态节点
3. 代码生成器：使用 AST 生成渲染函数

## 解析器

通过普通的 ES 对象，用以描述一个 DOM 节点的全部信息：`type` 属性表明类型、`parent` 属性表明父节点，`children` 属性表明子节点等，多个独立节点通过 `parent` 和 `children` 属性连接后形成一棵树，即 AST。

在解析成 AST 的过程中，HTML 解析器、文本解析器和过滤器解析器参与。

### HTML 解析器

HTML 解析器的核心思想是使用一个栈来记录节点的层级关系，从而在解析过程中构建出正确的节点树。HTML 解析器会按照以下方式工作：
1. 从前向后遍历模板字符串，使用正则表达式匹配不同类型的片段（如开始标签、结束标签、注释、文本等）
2. 根据匹配到的片段类型，触发不同的钩子函数（如 `start`、`end`、`comment`、`chars` 等），来构建对应的节点

在构建节点的过程中，使用一个栈来记录当前节点的层级关系：
- 遇到开始标签时：触发 `start` 函数创建节点并入栈
- 遇到结束标签时：触发 `end` 函数将栈顶节点出栈，并将其添加到父节点（当前栈顶节点）的子节点列表中

当 HTML 解析器执行完毕后，就可以得到一个完整的有 DOM 层级关系的 AST。

### 文本解析器

解析文本时，分为带变量的文本和不带变量的纯文本，带变量的文本需要进一步解析。

在解析带变量的文本节点时，解析器会将其转换为一个包含多个子节点的文本节点。其中，每个子节点要么是纯文本节点，要么是包含变量的文本节点。这些子节点会按照一定的顺序插入到父节点的子节点列表中，最终构成一个完整的节点树。


## 优化器

优化器的作用是在 AST 中找出并标记静态子树，静态子树在重新渲染时可以直接拷贝，并跳过 `patch` 过程，从而提高渲染性能。优化器过程如下：
1. 首先使用递归方式从上向下，根据 AST 中的节点 `type` 属性对静态节点对添加 `static` 属性，如果静态节点的子节点是动态节点，会将这个节点的 `static` 属性设置为 `false`
2. 然后使用递归方式从上到下对首次找到的静态节点添加 `staticRoot` 属性标记为静态根节点，同时不再向下继续寻找。以下两种特殊情况优化成本大于收益，不会被标记为静态根节点：
   - 静态根节点是只有一个文本子节点的节点
   - 静态根节点是没有子节点的静态节点

## 代码生成器

代码生成器的作用是将 AST 转换为**代码字符串**，通过调用 `new Function(代码字符串)` 转换成可执行的渲染函数。

通过递归 AST，从根节点开始，将节点转换成以下**代码字符串**：

```
'with (this) {
  return _c(
    "div",
    { attrs: {} },
    [_v("Hello, " + _s(world))]
  )
}'
```

元素节点和文本节点，通过对应的 `createElement()` 和 `createText()` 进行创建，在代码生成器内部封装成了对应的 `_c(tag, attrs, children)` 和 `_v` 函数。
